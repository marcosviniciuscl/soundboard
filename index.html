<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; media-src 'self' file:;">
    <title>Soundboard - Atalhos de √Åudio</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 20px;
            overflow-x: hidden;
        }
        
        /* ... (Todo o seu CSS existente) ... */
        
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 30px; }
        h1 { font-size: 2.5em; margin-bottom: 10px; background: linear-gradient(45deg, #4CAF50, #2196F3); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .subtitle { color: #aaaaaa; font-size: 1.1em; }
        .controls { display: flex; gap: 15px; margin-bottom: 30px; flex-wrap: wrap; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn-add { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; }
        .btn-edit { background: linear-gradient(135deg, #f39c12, #e67e22); color: white; }
        .btn-remove { background: linear-gradient(135deg, #f44336, #da190b); color: white; }
        .btn-test { background: linear-gradient(135deg, #2196F3, #0b7dda); color: white; }
        .sounds-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .sound-card { background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer; }
        .sound-card:hover { background: rgba(255, 255, 255, 0.08); border-color: #4CAF50; transform: translateY(-3px); box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2); }
        .sound-card.selected { border-color: #2196F3; background: rgba(33, 150, 243, 0.1); }
        .sound-name { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; color: #4CAF50; }
        .sound-hotkey { display: inline-block; background: rgba(255, 255, 255, 0.1); padding: 6px 12px; border-radius: 6px; font-family: 'Courier New', monospace; font-size: 0.9em; margin-bottom: 8px; color: #2196F3; }
        .sound-file { font-size: 0.85em; color: #aaaaaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin-bottom: 12px; }
        .sound-details { font-size: 0.9em; color: #ccc; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 10px; padding-top: 10px; border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .empty-state { text-align: center; padding: 60px 20px; color: #888; }
        .empty-state-icon { font-size: 4em; margin-bottom: 20px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(5px); overflow-y: auto; }
        .modal-content { background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%); margin: 5% auto; padding: 30px; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 16px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
        .modal-header { font-size: 1.8em; margin-bottom: 25px; color: #4CAF50; }
        .form-group { margin-bottom: 20px; }
        .form-group-inline { display: flex; gap: 15px; }
        .form-group-inline > div { flex: 1; }
        label { display: block; margin-bottom: 8px; color: #aaaaaa; font-weight: 500; }
        .slider-label { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .slider-label span { color: #fff; background: rgba(255, 255, 255, 0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.9em; }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; background: rgba(255, 255, 255, 0.05); color: white; font-size: 1em; }
        input[type="number"] { -moz-appearance: textfield; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="text"]:focus, input[type="number"]:focus { outline: none; border-color: #4CAF50; background: rgba(255, 255, 255, 0.08); }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 8px; border-radius: 5px; background: rgba(255, 255, 255, 0.1); outline: none; transition: background 0.3s; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; }
        input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; border-radius: 50%; background: #4CAF50; cursor: pointer; }
        .form-group-check { display: flex; align-items: center; gap: 12px; }
        .form-group-check label { margin-bottom: 0; }
        input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .file-selector { display: flex; gap: 10px; align-items: center; }
        .file-name { flex: 1; padding: 12px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #aaaaaa; }
        .modal-actions { display: flex; gap: 10px; margin-top: 25px; }
        .modal-actions button { flex: 1; }
        .info { text-align: center; padding: 15px; background: rgba(33, 150, 243, 0.1); border: 1px solid rgba(33, 150, 243, 0.3); border-radius: 8px; color: #2196F3; margin-top: 20px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px; }
        .close:hover { color: #fff; }

        /* MUDAN√áA: CSS para o seletor de √°udio */
        .audio-output-selector {
            margin-bottom: 20px;
            margin-top: 20px; /* Adicionado espa√ßo em cima */
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .audio-output-selector label {
            font-weight: bold;
            color: #aaaaaa;
            margin-bottom: 0; 
        }
        .audio-output-selector select {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            font-size: 1em;
        }

        /* MUDAN√áA: Cor de fundo das op√ß√µes do dropdown */
        .audio-output-selector select option {
            background: #2d2d2d;
            color: #ffffff;
        }

        /* MUDAN√áA: Estilos para a visualiza√ß√£o em tabela */
        .sounds-table-container {
            width: 100%;
            display: none; /* Come√ßa escondido */
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            overflow: hidden; /* Para o border-radius funcionar */
        }

        .sounds-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sounds-table th, .sounds-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sounds-table th {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            font-size: 0.9em;
            text-transform: uppercase;
        }

        .sounds-table tr {
            transition: background-color 0.2s ease;
            cursor: pointer;
        }

        .sounds-table tr:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .sounds-table tr:last-child td {
            border-bottom: none;
        }
        
        .sounds-table tr.selected {
            border-color: #2196F3; /* Mesmo que o card */
            background: rgba(33, 150, 243, 0.1); 
        }

        .sounds-table .sound-file {
            max-width: 200px; /* Limita a largura do nome do arquivo */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .sounds-table .sound-hotkey {
            font-size: 1em; /* Ajusta o tamanho do atalho na tabela */
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Hahaha</h1>
            <p class="subtitle">Atalhos de √°udio personalizados</p>
        </header>

        <div class="controls">
            <button class="btn-add" onclick="openAddModal()">‚ûï Adicionar √Åudio</button>
            <button class="btn-edit" onclick="openEditModal()">‚úèÔ∏è Editar Selecionado</button>
            <button class="btn-remove" onclick="removeSound()">üóëÔ∏è Remover Selecionado</button>
            <button class="btn-test" onclick="testSelected()">‚ñ∂Ô∏è Testar Som</button>
            <button id="viewToggleButton" class="btn-test" onclick="toggleView()" style="min-width: 60px; justify-content: center; font-size: 1.5em; padding: 10px;">
                ‚ò∞
            </button>
        </div>

        <div id="soundsContainer" class="sounds-grid">
            </div>
        
        <div id="tableContainer" class="sounds-table-container">
            </div>

        <!-- <div class="audio-output-selector">
            <label for="audioOutputSelect">üîä Sa√≠da de √Åudio:</label>
            <select id="audioOutputSelect" onchange="saveAudioDevice()">
                <option value="default">Padr√£o do Sistema</option>
            </select>
        </div> -->

        <div class="global-settings-container">
            <div class="audio-output-selector">
                <label for="audioOutputSelect">üîä Sa√≠da de √Åudio:</label>
                <select id="audioOutputSelect" onchange="saveGlobalSettings()">
                    <option value="default">Padr√£o do Sistema</option>
                </select>
            </div>
            
            <div class="audio-output-selector" style="margin-top: -10px;">
                <input type="checkbox" id="volumeBoostCheck" onchange="saveGlobalSettings()" style="width: 20px; height: 20px;">
                <label for="volumeBoostCheck" style="flex: 1; cursor: pointer;">‚ö° Ativar "Boost" de Volume (Sistema)</label>
                
                <input type="number" id="volumeBoostAmount" value="20" min="1" max="100" onchange="saveGlobalSettings()" style="width: 70px; padding: 10px;">
                <label for="volumeBoostAmount" style="margin-right: 5px;">+%</label>
            </div>
        </div>

        <div class="info">
            üí° Duplo clique para testar ‚Ä¢ Atalhos funcionam mesmo com a janela minimizada
        </div>
    </div>

    <!-- <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2 class="modal-header" id="modalTitle">Adicionar Novo Som</h2>
            <input type="hidden" id="originalSoundName" value="">
            <div class="form-group">
                <label>Nome do Som:</label>
                <input type="text" id="soundName" placeholder="Ex: Risada do Chaves">
            </div>
            <div class="form-group">
                <label>Atalho:</label>
                <input type="text" id="soundHotkey" placeholder="Clique aqui e pressione as teclas..." readonly style="cursor: pointer;">
                <small style="color: #888; display: block; margin-top: 5px;">
                    Use Ctrl, Shift, Alt.
                </small>
                <button class="btn-test" onclick="clearHotkey()" style="margin-top: 8px; width: 100%;">
                    üîÑ Limpar Atalho
                </button>
            </div>
            <div class="form-group">
                <label>Arquivo de √Åudio:</label>
                <div class="file-selector">
                    <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
                    <button class="btn-test" onclick="selectFile()" style="flex: 0 0 auto;">
                        üìÅ Escolher
                    </button>
                </div>
            </div>
            <div class="form-group form-group-inline">
                <div>
                    <label>In√≠cio (segundos):</label>
                    <input type="number" id="soundStartTime" min="0" step="0.1" value="0">
                </div>
                <div>
                    <label>Fim (segundos):</label>
                    <input type="number" id="soundEndTime" min="0" step="0.1" value="0">
                </div>
            </div>
             <small style="color: #888; display: block; margin-top: -15px; margin-bottom: 15px;">
                Deixe "Fim" como 0 para tocar at√© o final.
            </small>
            <div class="form-group">
                <div class="slider-label">
                    <label>Volume:</label>
                    <span id="volumeValue">100%</span>
                </div>
                <input type="range" id="soundVolume" min="0" max="1" step="0.01" value="1" oninput="updateSliderLabels()">
            </div>
            <div class="form-group">
                 <div class="slider-label">
                    <label>Velocidade:</label>
                    <span id="speedValue">1.0x</span>
                </div>
                <input type="range" id="soundSpeed" min="0.5" max="2" step="0.1" value="1" oninput="updateSliderLabels()">
            </div>
            <div class="form-group form-group-check">
                <input type="checkbox" id="soundLoop">
                <label for="soundLoop">Repetir (Loop)</label>
            </div>
            <div class="modal-actions">
                <button class="btn-add" onclick="saveSound()">üíæ Salvar</button>
                <button class="btn-remove" onclick="closeAddModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div> -->


    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2 class="modal-header" id="modalTitle">Adicionar Novo Som</h2>
            <input type="hidden" id="originalSoundName" value="">
            <div class="form-group">
                <label>Nome do Som:</label>
                <input type="text" id="soundName" placeholder="Ex: Risada do Chaves">
            </div>
            <div class="form-group">
                <label>Atalho:</label>
                <input type="text" id="soundHotkey" placeholder="Clique aqui e pressione as teclas..." readonly style="cursor: pointer;">
                <small style="color: #888; display: block; margin-top: 5px;">
                    Use Ctrl, Shift, Alt.
                </small>
                <button class="btn-test" onclick="clearHotkey()" style="margin-top: 8px; width: 100%;">
                    üîÑ Limpar Atalho
                </button>
            </div>
            <div class="form-group">
                <label>Arquivo de √Åudio:</label>
                <div class="file-selector">
                    <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
                    <button class="btn-test" onclick="selectFile()" style="flex: 0 0 auto;">
                        üìÅ Escolher
                    </button>
                </div>
                <small id="audioDuration" style="color: #888; display: block; margin-top: 5px; min-height: 1.2em;"></small>
            </div>
            <div class="form-group form-group-inline">
                <div>
                    <label>In√≠cio (segundos):</label>
                    <input type="number" id="soundStartTime" min="0" step="0.1" value="0">
                </div>
                <div>
                    <label>Fim (segundos):</label>
                    <input type="number" id="soundEndTime" min="0" step="0.1" value="0">
                </div>
            </div>
             <small style="color: #888; display: block; margin-top: -15px; margin-bottom: 15px;">
                Deixe "Fim" como 0 para tocar at√© o final.
            </small>
            <div class="form-group">
                <div class="slider-label">
                    <label>Volume:</label>
                    <span id="volumeValue">100%</span>
                </div>
                <input type="range" id="soundVolume" min="0" max="1" step="0.01" value="1" oninput="updateSliderLabels()">
            </div>
            <div class="form-group">
                 <div class="slider-label">
                    <label>Velocidade:</label>
                    <span id="speedValue">1.0x</span>
                </div>
                <input type="range" id="soundSpeed" min="0.5" max="2" step="0.1" value="1" oninput="updateSliderLabels()">
            </div>
            <div class="form-group form-group-check">
                <input type="checkbox" id="soundLoop">
                <label for="soundLoop">Repetir (Loop)</label>
            </div>
            
            <div class="modal-actions">
                <button class="btn-add" onclick="saveSound()">üíæ Salvar</button>
                <button class="btn-test" type="button" onclick="previewSound(event)">‚ñ∂Ô∏è Pr√©via</button>
                <button class="btn-remove" type="button" onclick="closeAddModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>


    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');

        let config = { settings: { audioDevice: 'default' }, sounds: {} };
        
        let selectedSound = null;
        let selectedFilePath = null;
        let currentAudio = null;
        let currentPlayingSoundName = null;
        let previewAudio = null;
        let previewStopTimer = null;
        let isCapturingHotkey = false;
        let capturedKeys = new Set();
        let stopAudioTimer = null;
        let currentView = 'grid';
        let originalSystemVolume = null;
        let isSystemVolumeBoosted = false;

        // async function loadConfig() {
        //     config = await ipcRenderer.invoke('load-config');

        //     if (!config.settings) config.settings = { audioDevice: 'default' };
        //     if (!config.sounds) config.sounds = {};

        //     await loadAudioDevices();

        //     const savedDevice = config.settings.audioDevice || 'default';
        //     document.getElementById('audioOutputSelect').value = savedDevice;

        //     renderSounds();
        // }

        async function loadConfig() {
            config = await ipcRenderer.invoke('load-config');

            // ... (Toda a sua l√≥gica de migra√ß√£o e √°udio... )
            if (!config.settings) config.settings = { audioDevice: 'default' };
            if (!config.sounds) config.sounds = {};
            await loadAudioDevices();
            const savedDevice = config.settings.audioDevice || 'default';
            document.getElementById('audioOutputSelect').value = savedDevice;

            // --- MUDAN√áA: Carrega as novas configura√ß√µes ---
            document.getElementById('volumeBoostCheck').checked = config.settings.volumeBoostEnabled || false;
            document.getElementById('volumeBoostAmount').value = config.settings.volumeBoostAmount || 20;
            // --- Fim da mudan√ßa ---

            renderSounds();
        }

        async function saveConfig() {
            await ipcRenderer.invoke('save-config', config);
        }

        function toggleView() {
            const gridContainer = document.getElementById('soundsContainer');
            const tableContainer = document.getElementById('tableContainer');
            const toggleButton = document.getElementById('viewToggleButton');

            if (currentView === 'grid') {
                currentView = 'table';
                toggleButton.innerHTML = "‚ñ¶"; // <<< MUDAN√áA: √çcone de Grade
                gridContainer.style.display = 'none';
                tableContainer.style.display = 'block';
            } else {
                currentView = 'grid';
                toggleButton.innerHTML = "‚ò∞"; // <<< MUDAN√áA: √çcone de Tabela
                gridContainer.style.display = 'grid'; // Use 'grid' para layout correto
                tableContainer.style.display = 'none';
            }
            
            renderSounds();
        }

        async function loadAudioDevices() {
            const select = document.getElementById('audioOutputSelect');
            select.innerHTML = '<option value="default">Padr√£o do Sistema</option>'; 

            try {
                await navigator.mediaDevices.getUserMedia({ audio: true });
            } catch (err) {
                console.warn('Permiss√£o de √°udio negada. Os nomes dos dispositivos podem n√£o aparecer.');
                alert('Por favor, permita o acesso ao microfone para listar os dispositivos de √°udio.');
            }

            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audiooutput');

                audioDevices.forEach(device => {
                    if (device.deviceId === 'default' || device.deviceId === 'communications') return;
                    
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Dispositivo ${select.options.length}`;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Erro ao listar dispositivos de √°udio:', err);
            }
        }

        async function saveGlobalSettings() {
            config.settings.audioDevice = document.getElementById('audioOutputSelect').value;
            config.settings.volumeBoostEnabled = document.getElementById('volumeBoostCheck').checked;
            config.settings.volumeBoostAmount = parseInt(document.getElementById('volumeBoostAmount').value) || 20;
            
            await saveConfig();
        }

        async function saveAudioDevice() {
            // const selectedDeviceId = document.getElementById('audioOutputSelect').value;
            // config.settings.audioDevice = selectedDeviceId;
            // await saveConfig();
            await saveGlobalSettings(); // MUDAN√áA: Apenas chama a fun√ß√£o principal
            alert('Sa√≠da de √°udio salva!');
        }

        function loadAudioDuration(filePath, callback) {
            const durationEl = document.getElementById('audioDuration');
            durationEl.textContent = 'Carregando dura√ß√£o...';
            
            try {
                const audio = new Audio(filePath);
                audio.onloadedmetadata = () => {
                    const duration = audio.duration;
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60);
                    durationEl.textContent = `Dura√ß√£o Total: ${minutes}:${seconds.toString().padStart(2, '0')} (${duration.toFixed(2)}s)`;
                    if (callback) callback(duration); // Chama o callback com a dura√ß√£o
                };
                audio.onerror = () => {
                    durationEl.textContent = 'Erro ao carregar o arquivo de √°udio.';
                };
            } catch (err) {
                durationEl.textContent = 'Erro ao carregar o √°udio.';
                console.error(err);
            }
        }

        async function previewSound(event) {
            event.preventDefault(); // Impede qualquer comportamento padr√£o do bot√£o
            const button = event.target.closest('button'); 

            // 1. Se o preview j√° est√° tocando, pare-o
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                previewAudio.src = '';
                previewAudio = null;
                if (previewStopTimer) clearTimeout(previewStopTimer);
                previewStopTimer = null;
                button.innerHTML = "‚ñ∂Ô∏è Pr√©via";

                await restoreVolumeBoost();
                return;
            }

            // 2. Verifique se um arquivo foi selecionado
            if (!selectedFilePath) {
                alert('Por favor, selecione um arquivo de √°udio primeiro!');
                return;
            }

            // 3. Pare qualquer √°udio principal que esteja tocando
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.src = ''; 
                currentAudio = null;
                currentPlayingSoundName = null;
                if (stopAudioTimer) {
                    clearTimeout(stopAudioTimer);
                    stopAudioTimer = null;
                }
            }

            await restoreVolumeBoost();
            
            // 4. Pegue todas as configura√ß√µes do modal
            const volume = parseFloat(document.getElementById('soundVolume').value);
            const speed = parseFloat(document.getElementById('soundSpeed').value);
            const loop = document.getElementById('soundLoop').checked;
            const startTime = parseFloat(document.getElementById('soundStartTime').value) || 0;
            const endTime = parseFloat(document.getElementById('soundEndTime').value) || 0;

            try {
                await applyVolumeBoost();

                // 5. Crie e configure o √°udio de preview
                previewAudio = new Audio(selectedFilePath);
                previewAudio.volume = volume;
                previewAudio.playbackRate = speed;
                previewAudio.loop = loop;
                previewAudio.currentTime = startTime;

                // 6. Defina o dispositivo de sa√≠da de √°udio (o mesmo selecionado no dropdown principal)
                const deviceId = document.getElementById('audioOutputSelect').value || 'default';
                if (deviceId !== 'default') {
                    try {
                        await previewAudio.setSinkId(deviceId);
                    } catch (err) {
                        console.error('Falha ao definir sa√≠da de √°udio para pr√©via:', err);
                        alert('Falha ao definir sa√≠da de √°udio para pr√©via.');
                    }
                }

                // 7. Toque o √°udio
                await previewAudio.play();
                button.innerHTML = "‚èπÔ∏è Parar"; // Mude o texto do bot√£o

                // 8. Limpe quando o √°udio terminar
                previewAudio.addEventListener('ended', () => {
                    button.innerHTML = "‚ñ∂Ô∏è Pr√©via";
                    previewAudio = null;
                    restoreVolumeBoost();
                });
                
                // 9. L√≥gica para 'endTime' (copiada de playSound)
                if (endTime > startTime && !previewAudio.loop) {
                    const durationInMs = (endTime - startTime) * 1000 / previewAudio.playbackRate;
                    previewStopTimer = setTimeout(() => {
                        if (previewAudio) {
                            previewAudio.pause();
                            previewAudio.currentTime = startTime;
                            // Dispara o evento 'ended' manualmente para resetar o bot√£o
                            previewAudio.dispatchEvent(new Event('ended')); 
                        }
                    }, durationInMs);
                }

                if (endTime > startTime && previewAudio.loop) {
                    previewAudio.addEventListener('timeupdate', function() {
                        if (this.currentTime >= endTime) {
                            this.currentTime = startTime;
                        }
                    });
                }
                
            } catch (err) {
                console.error('Erro ao reproduzir pr√©via:', err);
                alert('Erro ao reproduzir a pr√©via. Verifique o arquivo.');
                if (previewAudio) previewAudio = null;
                button.innerHTML = "‚ñ∂Ô∏è Pr√©via";
                restoreVolumeBoost();
            }
        }


        /**
         * Aumenta o volume do sistema se a op√ß√£o estiver marcada.
         */
        async function applyVolumeBoost() {
            const boostCheck = document.getElementById('volumeBoostCheck').checked;
            
            // S√≥ executa se o boost estiver ligado E o volume n√£o estiver j√° aumentado
            if (boostCheck && !isSystemVolumeBoosted) {
                try {
                    const currentVolume = await ipcRenderer.invoke('get-system-volume');
                    if (currentVolume === null) return; // Falha ao obter

                    originalSystemVolume = currentVolume; // Salva o volume original
                    
                    const boostAmount = parseInt(document.getElementById('volumeBoostAmount').value) || 20;
                    let newVolume = currentVolume + boostAmount;
                    if (newVolume > 100) newVolume = 100; // Limita em 100%

                    await ipcRenderer.invoke('set-system-volume', newVolume);
                    isSystemVolumeBoosted = true; // Marca que o volume foi aumentado
                } catch (err) {
                    console.error('Falha ao aplicar boost de volume:', err);
                }
            }
        }

        /**
         * Restaura o volume do sistema ao seu valor original.
         */
        async function restoreVolumeBoost() {
            // S√≥ executa se o volume estiver aumentado e tivermos um valor original
            if (isSystemVolumeBoosted && originalSystemVolume !== null) {
                try {
                    await ipcRenderer.invoke('set-system-volume', originalSystemVolume);
                    originalSystemVolume = null; // Limpa o valor
                    isSystemVolumeBoosted = false; // Marca que o volume foi restaurado
                } catch (err) {
                    console.error('Falha ao restaurar volume:', err);
                }
            }
        }




        // function renderSounds() {
        //     const container = document.getElementById('soundsContainer');
            
        //     if (Object.keys(config.sounds).length === 0) {
        //         container.innerHTML = `
        //             <div class="empty-state">
        //                 <div class="empty-state-icon">üéº</div>
        //                 <h3>Nenhum som adicionado ainda</h3>
        //                 <p>Clique em "Adicionar √Åudio" para come√ßar</p>
        //             </div>
        //         `;
        //         return;
        //     }

        //     container.innerHTML = '';
            
        //     Object.entries(config.sounds).forEach(([name, data]) => {
        //         const card = document.createElement('div');
        //         card.className = 'sound-card';
        //         if (selectedSound === name) {
        //             card.classList.add('selected');
        //         }
                
        //         const fileName = path.basename(data.path);
        //         const volume = (data.volume !== undefined ? data.volume : 1) * 100;
        //         const speed = data.speed !== undefined ? data.speed : 1;
        //         const loop = data.loop || false;
        //         const startTime = data.startTime || 0;
        //         const endTime = data.endTime || 0;
        //         const timeText = (endTime > startTime) ? `${startTime.toFixed(1)}s - ${endTime.toFixed(1)}s` : 'Completo';

        //         card.innerHTML = `
        //             <div class="sound-name">${name}</div>
        //             <div class="sound-hotkey">‚å®Ô∏è ${data.hotkey}</div>
        //             <div class="sound-file">üìÑ ${fileName}</div>
        //             <div class="sound-details">
        //                 <span>üîä ${volume.toFixed(0)}%</span>
        //                 <span>‚è© ${speed.toFixed(1)}x</span>
        //                 <span>${loop ? 'üîÑ Repetir' : '‚ñ∂Ô∏è Tocar 1x'}</span>
        //             </div>
        //             <div class="sound-details" style="border-top: none; padding-top: 5px;">
        //                  <span>‚è±Ô∏è ${timeText}</span>
        //             </div>
        //         `;
                
        //         card.onclick = () => selectSoundCard(name);
        //         card.ondblclick = () => playSound(name);
                
        //         container.appendChild(card);
        //     });
        // }

        // function renderSounds() {
        //     const gridContainer = document.getElementById('soundsContainer');
        //     const tableContainer = document.getElementById('tableContainer');

        //     // Pega as entradas do Objeto (como era antes)
        //     const soundEntries = Object.entries(config.sounds);

        //     // 1. L√≥gica do Estado Vazio
        //     if (soundEntries.length === 0) {
        //         const emptyHtml = `
        //             <div class="empty-state">
        //                 <div class="empty-state-icon">üéº</div>
        //                 <h3>Nenhum som adicionado ainda</h3>
        //                 <p>Clique em "Adicionar √Åudio" para come√ßar</p>
        //             </div>
        //         `;
                
        //         if (currentView === 'grid') {
        //             gridContainer.innerHTML = emptyHtml;
        //             tableContainer.innerHTML = ''; // Limpa a outra view
        //         } else {
        //             tableContainer.innerHTML = emptyHtml;
        //             gridContainer.innerHTML = ''; // Limpa a outra view
        //         }
        //         return; // Para aqui
        //     }

        //     // 2. Limpa ambos os containers
        //     gridContainer.innerHTML = '';
        //     tableContainer.innerHTML = '';

        //     // 3. Renderiza a view correta
        //     if (currentView === 'grid') {
        //         // --- L√ìGICA DA GRADE (a que voc√™ j√° tinha) ---
        //         soundEntries.forEach(([name, data]) => {
        //             const card = document.createElement('div');
        //             card.className = 'sound-card';
        //             if (selectedSound === name) {
        //                 card.classList.add('selected');
        //             }
                    
        //             const fileName = path.basename(data.path);
        //             const volume = (data.volume !== undefined ? data.volume : 1) * 100;
        //             const speed = data.speed !== undefined ? data.speed : 1;
        //             const loop = data.loop || false;
        //             const startTime = data.startTime || 0;
        //             const endTime = data.endTime || 0;
        //             const timeText = (endTime > startTime) ? `${startTime.toFixed(1)}s - ${endTime.toFixed(1)}s` : 'Completo';

        //             card.innerHTML = `
        //                 <div class="sound-name">${name}</div>
        //                 <div class="sound-hotkey">‚å®Ô∏è ${data.hotkey}</div>
        //                 <div class="sound-file">üìÑ ${fileName}</div>
        //                 <div class="sound-details">
        //                     <span>üîä ${volume.toFixed(0)}%</span>
        //                     <span>‚è© ${speed.toFixed(1)}x</span>
        //                     <span>${loop ? 'üîÑ Repetir' : '‚ñ∂Ô∏è Tocar 1x'}</span>
        //                 </div>
        //                 <div class="sound-details" style="border-top: none; padding-top: 5px;">
        //                      <span>‚è±Ô∏è ${timeText}</span>
        //                 </div>
        //             `;
                    
        //             card.onclick = () => selectSoundCard(name);
        //             card.ondblclick = () => playSound(name);
                    
        //             gridContainer.appendChild(card);
        //         });

        //     } else {
        //         // --- L√ìGICA DA TABELA (Nova) ---
        //         let tableHtml = `
        //             <table class="sounds-table">
        //                 <thead>
        //                     <tr>
        //                         <th>Nome</th>
        //                         <th>Atalho</th>
        //                         <th>Arquivo</th>
        //                         <th>Volume</th>
        //                         <th>Velocidade</th>
        //                         <th>Loop</th>
        //                     </tr>
        //                 </thead>
        //                 <tbody>
        //         `;

        //         soundEntries.forEach(([name, data]) => {
        //             const isSelected = (selectedSound === name) ? 'selected' : '';
        //             const fileName = path.basename(data.path);
        //             const volume = (data.volume !== undefined ? data.volume : 1) * 100;
        //             const speed = data.speed !== undefined ? data.speed : 1;
        //             const loop = data.loop ? 'Sim' : 'N√£o';

        //             // Usamos JSON.stringify(name) para lidar com nomes que 
        //             // possam ter aspas ou caracteres especiais com seguran√ßa
        //             tableHtml += `
        //                 <tr class="${isSelected}" 
        //                     onclick="selectSoundCard(${JSON.stringify(name)})" 
        //                     ondblclick="playSound(${JSON.stringify(name)})">
                            
        //                     <td>${name}</td>
        //                     <td><span class="sound-hotkey">${data.hotkey}</span></td>
        //                     <td class="sound-file" title="${data.path}">${fileName}</td>
        //                     <td>${volume.toFixed(0)}%</td>
        //                     <td>${speed.toFixed(1)}x</td>
        //                     <td>${loop}</td>
        //                 </tr>
        //             `;
        //         });

        //         tableHtml += `</tbody></table>`;
        //         tableContainer.innerHTML = tableHtml;
        //     }
        // }

        function renderSounds() {
            const gridContainer = document.getElementById('soundsContainer');
            const tableContainer = document.getElementById('tableContainer');

            const soundEntries = Object.entries(config.sounds);

            // 1. L√≥gica do Estado Vazio
            if (soundEntries.length === 0) {
                const emptyHtml = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéº</div>
                        <h3>Nenhum som adicionado ainda</h3>
                        <p>Clique em "Adicionar √Åudio" para come√ßar</p>
                    </div>
                `;
                
                if (currentView === 'grid') {
                    gridContainer.innerHTML = emptyHtml;
                    tableContainer.innerHTML = ''; 
                } else {
                    tableContainer.innerHTML = emptyHtml;
                    gridContainer.innerHTML = ''; 
                }
                return;
            }

            // 2. Limpa ambos os containers
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';

            // 3. Renderiza a view correta
            if (currentView === 'grid') {
                // --- L√ìGICA DA GRADE ---
                soundEntries.forEach(([name, data]) => {
                    const card = document.createElement('div');
                    card.className = 'sound-card';
                    if (selectedSound === name) {
                        card.classList.add('selected');
                    }
                    
                    const fileName = path.basename(data.path);
                    const volume = (data.volume !== undefined ? data.volume : 1) * 100;
                    const speed = data.speed !== undefined ? data.speed : 1;
                    const loop = data.loop || false;
                    const startTime = data.startTime || 0;
                    const endTime = data.endTime || 0;
                    const timeText = (endTime > startTime) ? `${startTime.toFixed(1)}s - ${endTime.toFixed(1)}s` : 'Completo';

                    card.innerHTML = `
                        <div class="sound-name">${name}</div>
                        <div class="sound-hotkey">‚å®Ô∏è ${data.hotkey}</div>
                        <div class="sound-file">üìÑ ${fileName}</div>
                        <div class="sound-details">
                            <span>üîä ${volume.toFixed(0)}%</span>
                            <span>‚è© ${speed.toFixed(1)}x</span>
                            <span>${loop ? 'üîÑ Repetir' : '‚ñ∂Ô∏è Tocar 1x'}</span>
                        </div>
                        <div class="sound-details" style="border-top: none; padding-top: 5px;">
                             <span>‚è±Ô∏è ${timeText}</span>
                        </div>
                    `;
                    
                    card.onclick = () => selectSoundCard(name);
                    // MUDAN√áA: A linha 'card.ondblclick' foi removida.
                    
                    gridContainer.appendChild(card);
                });

            } else {
                // --- L√ìGICA DA TABELA ---
                let tableHtml = `
                    <table class="sounds-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Atalho</th>
                                <th>Arquivo</th>
                                <th>Volume</th>
                                <th>Velocidade</th>
                                <th>Loop</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                soundEntries.forEach(([name, data]) => {
                    const isSelected = (selectedSound === name) ? 'selected' : '';
                    const fileName = path.basename(data.path);
                    const volume = (data.volume !== undefined ? data.volume : 1) * 100;
                    const speed = data.speed !== undefined ? data.speed : 1;
                    const loop = data.loop ? 'Sim' : 'N√£o';

                    // MUDAN√áA: O 'ondblclick' foi removido da tag <tr>
                    tableHtml += `
                        <tr class="${isSelected}" 
                            onclick="selectSoundCard(${JSON.stringify(name)})">
                            
                            <td>${name}</td>
                            <td><span class="sound-hotkey">${data.hotkey}</span></td>
                            <td class="sound-file" title="${data.path}">${fileName}</td>
                            <td>${volume.toFixed(0)}%</td>
                            <td>${speed.toFixed(1)}x</td>
                            <td>${loop}</td>
                        </tr>
                    `;
                });

                tableHtml += `</tbody></table>`;
                tableContainer.innerHTML = tableHtml;
            }
        }

        function selectSoundCard(name) {
            selectedSound = name;
            renderSounds();
            playSound(name);
        }

        function updateSliderLabels() {
            try {
                const vol = document.getElementById('soundVolume').value;
                document.getElementById('volumeValue').textContent = `${Math.round(vol * 100)}%`;
                const speed = document.getElementById('soundSpeed').value;
                document.getElementById('speedValue').textContent = `${parseFloat(speed).toFixed(1)}x`;
            } catch (e) {}
        }

        // function openAddModal() {
        //     document.getElementById('modalTitle').textContent = 'Adicionar Novo Som';
        //     document.getElementById('originalSoundName').value = ''; 
        //     document.getElementById('soundName').value = '';
        //     document.getElementById('soundHotkey').value = '';
        //     document.getElementById('fileName').textContent = 'Nenhum arquivo selecionado';
        //     selectedFilePath = null;
        //     document.getElementById('soundVolume').value = 1;
        //     document.getElementById('soundSpeed').value = 1;
        //     document.getElementById('soundLoop').checked = false;
        //     document.getElementById('soundStartTime').value = 0;
        //     document.getElementById('soundEndTime').value = 0;
        //     updateSliderLabels(); 
        //     setupHotkeyCapture();
        //     document.getElementById('addModal').style.display = 'block';
        // }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Adicionar Novo Som';
            document.getElementById('originalSoundName').value = ''; 
            document.getElementById('soundName').value = '';
            document.getElementById('soundHotkey').value = '';
            document.getElementById('fileName').textContent = 'Nenhum arquivo selecionado';
            document.getElementById('audioDuration').textContent = '';
            selectedFilePath = null;
            document.getElementById('soundVolume').value = 1;
            document.getElementById('soundSpeed').value = 1;
            document.getElementById('soundLoop').checked = false;
            document.getElementById('soundStartTime').value = 0;
            document.getElementById('soundEndTime').value = 0;
            updateSliderLabels(); 
            setupHotkeyCapture();
            document.getElementById('addModal').style.display = 'block';
        }

        // function openEditModal() {
        //     if (!selectedSound || !config.sounds[selectedSound]) {
        //         alert('Selecione um som para editar!');
        //         return;
        //     }

        //     const data = config.sounds[selectedSound]; 

        //     document.getElementById('modalTitle').textContent = 'Editar Som';
        //     document.getElementById('originalSoundName').value = selectedSound; 
        //     document.getElementById('soundName').value = selectedSound;
        //     document.getElementById('soundHotkey').value = data.hotkey;
        //     document.getElementById('fileName').textContent = path.basename(data.path);
        //     selectedFilePath = data.path;
        //     document.getElementById('soundVolume').value = data.volume !== undefined ? data.volume : 1;
        //     document.getElementById('soundSpeed').value = data.speed !== undefined ? data.speed : 1;
        //     document.getElementById('soundLoop').checked = data.loop || false;
        //     document.getElementById('soundStartTime').value = data.startTime || 0;
        //     document.getElementById('soundEndTime').value = data.endTime || 0;
        //     updateSliderLabels(); 
        //     setupHotkeyCapture();
        //     document.getElementById('addModal').style.display = 'block';
        // }

        function openEditModal() {
            if (!selectedSound || !config.sounds[selectedSound]) {
                alert('Selecione um som para editar!');
                return;
            }

            const data = config.sounds[selectedSound]; 

            document.getElementById('modalTitle').textContent = 'Editar Som';
            document.getElementById('originalSoundName').value = selectedSound; 
            document.getElementById('soundName').value = selectedSound;
            document.getElementById('soundHotkey').value = data.hotkey;
            document.getElementById('fileName').textContent = path.basename(data.path);
            selectedFilePath = data.path;
            
            loadAudioDuration(selectedFilePath); // <<< MUDAN√áA: Carrega a dura√ß√£o
            
            document.getElementById('soundVolume').value = data.volume !== undefined ? data.volume : 1;
            document.getElementById('soundSpeed').value = data.speed !== undefined ? data.speed : 1;
            document.getElementById('soundLoop').checked = data.loop || false;
            document.getElementById('soundStartTime').value = data.startTime || 0;
            document.getElementById('soundEndTime').value = data.endTime || 0;
            updateSliderLabels(); 
            setupHotkeyCapture();
            document.getElementById('addModal').style.display = 'block';
        }


        // function closeAddModal() {
        //     document.getElementById('addModal').style.display = 'none';
        //     isCapturingHotkey = false;
        //     capturedKeys.clear();
        //     selectedFilePath = null;
        //     document.getElementById('originalSoundName').value = '';
        // }

        function closeAddModal() {
            // --- MUDAN√áA: Para o √°udio de preview se estiver tocando ---
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.src = '';
                previewAudio = null;
                if (previewStopTimer) clearTimeout(previewStopTimer);
                previewStopTimer = null;
            }
            // --- Fim da mudan√ßa ---

            document.getElementById('addModal').style.display = 'none';
            isCapturingHotkey = false;
            capturedKeys.clear();
            selectedFilePath = null;
            document.getElementById('originalSoundName').value = '';
            document.getElementById('audioDuration').textContent = ''; // Limpa a dura√ß√£o
        }

        // async function selectFile() {
        //     const filePath = await ipcRenderer.invoke('select-audio-file');
        //     if (filePath) {
        //         selectedFilePath = filePath;
        //         document.getElementById('fileName').textContent = path.basename(filePath);
        //     }
        // }

        async function selectFile() {
            const filePath = await ipcRenderer.invoke('select-audio-file');
            if (filePath) {
                selectedFilePath = filePath;
                document.getElementById('fileName').textContent = path.basename(filePath);
                
                // --- MUDAN√áA: Chama a fun√ß√£o para carregar a dura√ß√£o ---
                // E passa um callback para auto-preencher o campo "Fim"
                loadAudioDuration(filePath, (duration) => {
                    const endTimeInput = document.getElementById('soundEndTime');
                    // S√≥ auto-preenche se o valor for 0
                    if (parseFloat(endTimeInput.value) === 0) {
                         endTimeInput.value = duration.toFixed(2);
                    }
                });
            }
        }

        async function saveSound() {
            const name = document.getElementById('soundName').value.trim();
            const hotkey = document.getElementById('soundHotkey').value.trim();
            const originalName = document.getElementById('originalSoundName').value;
            const volume = parseFloat(document.getElementById('soundVolume').value);
            const speed = parseFloat(document.getElementById('soundSpeed').value);
            const loop = document.getElementById('soundLoop').checked;
            const startTime = parseFloat(document.getElementById('soundStartTime').value) || 0;
            const endTime = parseFloat(document.getElementById('soundEndTime').value) || 0;

            if (!name) { alert('Por favor, insira um nome para o som!'); return; }
            if (!hotkey) { alert('Por favor, insira um atalho!'); return; }
            if (!selectedFilePath) { alert('Por favor, selecione um arquivo de √°udio!'); return; }
            
            if (name !== originalName && config.sounds[name]) { 
                alert(`O nome "${name}" j√° est√° em uso. Escolha outro nome.`);
                return;
            }
            
            if (originalName && originalName !== name) {
                delete config.sounds[originalName]; 
            }
            
            config.sounds[name] = { 
                path: selectedFilePath,
                hotkey: hotkey,
                volume: volume,
                speed: speed,
                loop: loop,
                startTime: startTime,
                endTime: endTime
            };
            
            await saveConfig();
            selectedSound = name; 
            renderSounds();
            closeAddModal();
            alert(`Som "${name}" salvo com sucesso!`);
        }

        async function removeSound() {
            if (!selectedSound) {
                alert('Selecione um som para remover!');
                return;
            }
            if (confirm(`Deseja remover o som "${selectedSound}"?`)) {
                delete config.sounds[selectedSound]; 
                await saveConfig();
                selectedSound = null;
                renderSounds();
            }
        }

        function testSelected() {
            if (!selectedSound) {
                alert('Selecione um som para testar!');
                return;
            }
            playSound(selectedSound);
        }

        // async function playSound(name) {
        //     if (!config.sounds[name]) return; 
            
        //     const data = config.sounds[name]; 

        //     if (currentAudio) {
        //         currentAudio.pause();
        //         currentAudio.currentTime = 0;
        //         currentAudio.src = ''; 
        //         currentAudio = null;
        //     }
        //     if (stopAudioTimer) {
        //         clearTimeout(stopAudioTimer);
        //         stopAudioTimer = null;
        //     }
            
        //     try {
        //         currentAudio = new Audio(data.path);

        //         const startTime = data.startTime || 0;
        //         const endTime = data.endTime || 0;

        //         currentAudio.volume = data.volume !== undefined ? data.volume : 1;
        //         currentAudio.playbackRate = data.speed !== undefined ? data.speed : 1;
        //         currentAudio.loop = data.loop || false;
        //         currentAudio.currentTime = startTime;

        //         const deviceId = config.settings.audioDevice || 'default';
        //         if (deviceId !== 'default') {
        //             try {
        //                 await currentAudio.setSinkId(deviceId);
        //             } catch (err) {
        //                 console.error('Falha ao definir a sa√≠da de √°udio:', err);
        //                 alert('Erro! N√£o foi poss√≠vel alterar a sa√≠da de √°udio. Voltando para o Padr√£o.');
        //                 config.settings.audioDevice = 'default';
        //                 document.getElementById('audioOutputSelect').value = 'default';
        //                 await saveConfig();
        //             }
        //         }

        //         currentAudio.play().catch(err => {
        //             console.error('Erro ao reproduzir √°udio:', err);
        //             alert('Erro ao reproduzir o √°udio. Verifique se o arquivo existe.');
        //             currentAudio = null;
        //         });

        //         if (endTime > startTime && !currentAudio.loop) {
        //             const durationInMs = (endTime - startTime) * 1000 / currentAudio.playbackRate;
        //             stopAudioTimer = setTimeout(() => {
        //                 if (currentAudio) {
        //                     currentAudio.pause();
        //                     currentAudio.currentTime = startTime;
        //                 }
        //             }, durationInMs);
        //         }

        //         if (endTime > startTime && currentAudio.loop) {
        //             currentAudio.addEventListener('timeupdate', function() {
        //                 if (this.currentTime >= endTime) {
        //                     this.currentTime = startTime;
        //                 }
        //             });
        //         }

        //     } catch (error) {
        //         console.error('Erro ao criar Audio:', error);
        //         alert('Erro ao carregar o √°udio.');
        //         currentAudio = null;
        //     }
        // }

        async function playSound(name) {
            const data = config.sounds[name];
            if (!data) return;

            // --- NOVO BLOCO DE C√ìDIGO ---
            // Verifica se o som ATUAL √© o MESMO que foi pedido
            // if (currentAudio && currentPlayingSoundName === name && !currentAudio.paused) {
            //     // √â o mesmo som, e ele est√° tocando. Pare ele.
            //     currentAudio.pause();
            //     currentAudio.currentTime = 0; 
            //     currentAudio.src = ''; // Limpa a fonte
            //     currentAudio = null; // Descarta o √°udio
            //     currentPlayingSoundName = null; // Limpa o nome
                
            //     if (stopAudioTimer) {
            //         clearTimeout(stopAudioTimer);
            //         stopAudioTimer = null;
            //     }
            //     return; // Sai da fun√ß√£o
            // }
            // --- FIM DO NOVO BLOCO ---

            if (currentAudio && currentPlayingSoundName === name && !currentAudio.paused) {
                currentAudio.pause();
                currentAudio.currentTime = 0; 
                currentAudio.src = ''; 
                currentAudio = null; 
                currentPlayingSoundName = null; 
                
                if (stopAudioTimer) {
                    clearTimeout(stopAudioTimer);
                    stopAudioTimer = null;
                }
                
                await restoreVolumeBoost(); // <<< RESTAURA O VOLUME
                return; 
            }

            // Se chegou aqui, ou √© um som diferente, ou nenhum som estava tocando.
            // Pare qualquer som que ESTIVESSE tocando (c√≥digo que j√° existia)
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.src = ''; 
                currentAudio = null;
            }
            if (stopAudioTimer) {
                clearTimeout(stopAudioTimer);
                stopAudioTimer = null;
            }

            await restoreVolumeBoost();
            
            // Toca o novo som
            try {
                await applyVolumeBoost();

                currentAudio = new Audio(data.path);
                currentPlayingSoundName = name; // <<< NOVO: Guarda o nome do som atual

                const startTime = data.startTime || 0;
                const endTime = data.endTime || 0;

                currentAudio.volume = data.volume !== undefined ? data.volume : 1;
                currentAudio.playbackRate = data.speed !== undefined ? data.speed : 1;
                currentAudio.loop = data.loop || false;
                currentAudio.currentTime = startTime;

                // <<< NOVO: Limpa o nome quando o √°udio terminar sozinho
                currentAudio.addEventListener('ended', () => {
                    currentPlayingSoundName = null;
                });

                const deviceId = config.settings.audioDevice || 'default';
                if (deviceId !== 'default') {
                    try {
                        await currentAudio.setSinkId(deviceId);
                    } catch (err) {
                        console.error('Falha ao definir a sa√≠da de √°udio:', err);
                        alert('Erro! N√£o foi poss√≠vel alterar a sa√≠da de √°udio. Voltando para o Padr√£o.');
                        config.settings.audioDevice = 'default';
                        document.getElementById('audioOutputSelect').value = 'default';
                        await saveConfig();
                    }
                }

                currentAudio.play().catch(err => {
                    console.error('Erro ao reproduzir √°udio:', err);
                    alert('Erro ao reproduzir o √°udio. Verifique se o arquivo existe.');
                    currentAudio = null;
                    currentPlayingSoundName = null;
                    restoreVolumeBoost();
                });

                // L√≥gica do temporizador (endTime)
                if (endTime > startTime && !currentAudio.loop) {
                    const durationInMs = (endTime - startTime) * 1000 / currentAudio.playbackRate;
                    stopAudioTimer = setTimeout(() => {
                        // NOVO: Verifica se ainda √© o som certo antes de parar
                        if (currentAudio && currentPlayingSoundName === name) { 
                            currentAudio.pause();
                            currentAudio.currentTime = startTime;
                            currentPlayingSoundName = null;
                            restoreVolumeBoost();
                        }
                    }, durationInMs);
                }

                if (endTime > startTime && currentAudio.loop) {
                    currentAudio.addEventListener('timeupdate', function() {
                        if (this.currentTime >= endTime) {
                            this.currentTime = startTime;
                        }
                    });
                }

            } catch (error) {
                console.error('Erro ao criar Audio:', error);
                alert('Erro ao carregar o √°udio.');
                currentAudio = null;
                currentPlayingSoundName = null;
                restoreVolumeBoost();
            }
        }

        ipcRenderer.on('play-sound', (event, name) => {
            playSound(name); 
        });

        window.onclick = function(event) {
            const modal = document.getElementById('addModal');
            if (event.target === modal) {
                closeAddModal();
            }
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('addModal').style.display === 'block') {
                if (!isCapturingHotkey) {
                    saveSound();
                }
            }
            if (e.key === 'Escape') {
                closeAddModal();
            }
        });

        function setupHotkeyCapture() {
            const hotkeyInput = document.getElementById('soundHotkey');
            
            hotkeyInput.addEventListener('focus', () => {
                isCapturingHotkey = true;
                capturedKeys.clear();
                hotkeyInput.value = '';
                hotkeyInput.placeholder = 'Pressione as teclas...';
            });
            
            hotkeyInput.addEventListener('blur', () => {
                isCapturingHotkey = false; 
                if (hotkeyInput.value === '') {
                    hotkeyInput.placeholder = 'Clique aqui e pressione as teclas...';
                }
            });
        }

        document.addEventListener('keydown', (e) => {
            const hotkeyInput = document.getElementById('soundHotkey');
            
            if (isCapturingHotkey && document.getElementById('addModal').style.display === 'block') {
                e.preventDefault();
                
                if (['Control', 'Shift', 'Alt'].includes(e.key)) {
                    return;
                }
                
                const keys = [];
                
                if (e.ctrlKey) {
                    keys.push('CommandOrControl');
                }
                if (e.shiftKey) {
                    keys.push('Shift');
                }
                if (e.altKey) {
                    keys.push('Alt');
                }
                
                let key = e.key;
                
                const specialKeys = {
                    ' ': 'Space', 'ArrowUp': 'Up', 'ArrowDown': 'Down',
                    'ArrowLeft': 'Left', 'ArrowRight': 'Right', 'Escape': 'Esc'
                };
                
                if (specialKeys[key]) {
                    key = specialKeys[key];
                } else if (key.length === 1) {
                    key = key.toUpperCase();
                }
                
                if (!['CONTROL', 'SHIFT', 'ALT'].includes(key.toUpperCase())) {
                     keys.push(key);
                }
               
                const hotkey = keys.join('+');
                hotkeyInput.value = hotkey;
                
                setTimeout(() => {
                    isCapturingHotkey = false;
                    hotkeyInput.blur();
                }, 100);
            }
        });

        function clearHotkey() {
            document.getElementById('soundHotkey').value = '';
            capturedKeys.clear();
        }

        const notification = document.getElementById('notification');
        const message = document.getElementById('notificationMessage');
        const restartButton = document.getElementById('restartButton');

        ipcRenderer.on('update-available', () => {
          ipcRenderer.removeAllListeners('update-available');
          message.innerText = 'Uma nova atualiza√ß√£o est√° sendo baixada...';
          notification.classList.add('show');
        });

        ipcRenderer.on('update-downloaded', () => {
          ipcRenderer.removeAllListeners('update-downloaded');
          message.innerText = 'Atualiza√ß√£o pronta! Reiniciar agora para instalar?';
          restartButton.style.display = 'flex'; // Mostra o bot√£o
          notification.classList.add('show');
        });

        function restartApp() {
          ipcRenderer.send('restart-app');
        }
        loadConfig();

        navigator.mediaDevices.ondevicechange = (event) => {
            console.log('Dispositivos de m√≠dia mudaram! Recarregando lista de √°udio...');
            
            const select = document.getElementById('audioOutputSelect');
            const valorAntigo = select.value;

            loadAudioDevices().then(() => {
                if (Array.from(select.options).some(opt => opt.value === valorAntigo)) {
                    select.value = valorAntigo;
                } else {
                    select.value = 'default';
                    saveAudioDevice();
                }
            });
        };
    </script>
</body>
</html>


<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline'; media-src 'self' file:;">
    <title>Soundboard - Atalhos de √Åudio</title>
    <style>
        /* ... (NENHUMA MUDAN√áA NO CSS, PODE MANTER O SEU) ... */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
            color: #ffffff;
            padding: 20px;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4CAF50, #2196F3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #aaaaaa;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .btn-add {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }
        
        .btn-edit {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-remove {
            background: linear-gradient(135deg, #f44336, #da190b);
            color: white;
        }

        .btn-test {
            background: linear-gradient(135deg, #2196F3, #0b7dda);
            color: white;
        }

        .sounds-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .sound-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .sound-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: #4CAF50;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.2);
        }

        .sound-card.selected {
            border-color: #2196F3;
            background: rgba(33, 150, 243, 0.1);
        }

        .sound-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4CAF50;
        }

        .sound-hotkey {
            display: inline-block;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin-bottom: 8px;
            color: #2196F3;
        }

        .sound-file {
            font-size: 0.85em;
            color: #aaaaaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            margin-bottom: 12px;
        }

        .sound-details {
            font-size: 0.9em;
            color: #ccc;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            overflow-y: auto;
        }

        .modal-content {
            background: linear-gradient(135deg, #2d2d2d 0%, #1e1e1e 100%);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .modal-header {
            font-size: 1.8em;
            margin-bottom: 25px;
            color: #4CAF50;
        }

        .form-group {
            margin-bottom: 20px;
        }
        
        /* NOVO: Para agrupar In√≠cio/Fim */
        .form-group-inline {
            display: flex;
            gap: 15px;
        }
        .form-group-inline > div {
            flex: 1;
        }


        label {
            display: block;
            margin-bottom: 8px;
            color: #aaaaaa;
            font-weight: 500;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .slider-label span {
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="number"] { /* MUDAN√áA: Estilo aplicado a number */
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            font-size: 1em;
        }
        
        input[type="number"] {
            -moz-appearance: textfield; /* Remove setas no Firefox */
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none; /* Remove setas no Chrome/Safari */
            margin: 0;
        }

        input[type="text"]:focus,
        input[type="number"]:focus { /* MUDAN√áA: Estilo aplicado a number */
            outline: none;
            border-color: #4CAF50;
            background: rgba(255, 255, 255, 0.08);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            transition: background 0.3s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
        }

        .form-group-check {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .form-group-check label {
            margin-bottom: 0;
        }
        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }


        .file-selector {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .file-name {
            flex: 1;
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #aaaaaa;
        }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }

        .modal-actions button {
            flex: 1;
        }

        .info {
            text-align: center;
            padding: 15px;
            background: rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.3);
            border-radius: 8px;
            color: #2196F3;
            margin-top: 20px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }

        .close:hover {
            color: #fff;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Soundboard</h1>
            <p class="subtitle">Atalhos de √°udio personalizados</p>
        </header>

        <div class="controls">
            <button class="btn-add" onclick="openAddModal()">
                ‚ûï Adicionar √Åudio
            </button>
            <button class="btn-edit" onclick="openEditModal()">
                ‚úèÔ∏è Editar Selecionado
            </button>
            <button class="btn-remove" onclick="removeSound()">
                üóëÔ∏è Remover Selecionado
            </button>
            <button class="btn-test" onclick="testSelected()">
                ‚ñ∂Ô∏è Testar Som
            </button>
        </div>

        <div id="soundsContainer" class="sounds-grid">
            </div>

        <div class="info">
            üí° Duplo clique para testar ‚Ä¢ Atalhos funcionam mesmo com a janela minimizada
        </div>
    </div>

    <div id="addModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeAddModal()">&times;</span>
            <h2 class="modal-header" id="modalTitle">Adicionar Novo Som</h2>
            
            <input type="hidden" id="originalSoundName" value="">

            <div class="form-group">
                <label>Nome do Som:</label>
                <input type="text" id="soundName" placeholder="Ex: Risada do Chaves">
            </div>

            <div class="form-group">
                <label>Atalho:</label>
                <input type="text" id="soundHotkey" placeholder="Clique aqui e pressione as teclas..." readonly style="cursor: pointer;">
                <small style="color: #888; display: block; margin-top: 5px;">
                    Inclui Ctrl, Shift, Alt, e a tecla Windows (Super)
                </small>
                <button class="btn-test" onclick="clearHotkey()" style="margin-top: 8px; width: 100%;">
                    üîÑ Limpar Atalho
                </button>
            </div>

            <div class="form-group">
                <label>Arquivo de √Åudio:</label>
                <div class="file-selector">
                    <div class="file-name" id="fileName">Nenhum arquivo selecionado</div>
                    <button class="btn-test" onclick="selectFile()" style="flex: 0 0 auto;">
                        üìÅ Escolher
                    </button>
                </div>
            </div>

            <div class="form-group form-group-inline">
                <div>
                    <label>In√≠cio (segundos):</label>
                    <input type="number" id="soundStartTime" min="0" step="0.1" value="0">
                </div>
                <div>
                    <label>Fim (segundos):</label>
                    <input type="number" id="soundEndTime" min="0" step="0.1" value="0">
                </div>
            </div>
             <small style="color: #888; display: block; margin-top: -15px; margin-bottom: 15px;">
                Deixe "Fim" como 0 para tocar at√© o final.
            </small>
            <div class="form-group">
                <div class="slider-label">
                    <label>Volume:</label>
                    <span id="volumeValue">100%</span>
                </div>
                <input type="range" id="soundVolume" min="0" max="1" step="0.01" value="1" oninput="updateSliderLabels()">
            </div>
            
            <div class="form-group">
                 <div class="slider-label">
                    <label>Velocidade:</label>
                    <span id="speedValue">1.0x</span>
                </div>
                <input type="range" id="soundSpeed" min="0.5" max="2" step="0.1" value="1" oninput="updateSliderLabels()">
            </div>

            <div class="form-group form-group-check">
                <input type="checkbox" id="soundLoop">
                <label for="soundLoop">Repetir (Loop)</label>
            </div>

            <div class="modal-actions">
                <button class="btn-add" onclick="saveSound()">üíæ Salvar</button>
                <button class="btn-remove" onclick="closeAddModal()">‚ùå Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        const path = require('path');

        let sounds = {};
        let selectedSound = null;
        let selectedFilePath = null;
        let currentAudio = null;
        let isCapturingHotkey = false;
        let capturedKeys = new Set();
        let stopAudioTimer = null; // Timer para cortar o √°udio

        loadConfig();

        async function loadConfig() {
            sounds = await ipcRenderer.invoke('load-config');
            renderSounds();
        }

        async function saveConfig() {
            await ipcRenderer.invoke('save-config', sounds);
        }

        function renderSounds() {
            const container = document.getElementById('soundsContainer');
            
            if (Object.keys(sounds).length === 0) {
                // ... (sem mudan√ßas aqui) ...
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üéº</div>
                        <h3>Nenhum som adicionado ainda</h3>
                        <p>Clique em "Adicionar √Åudio" para come√ßar</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = '';
            
            Object.entries(sounds).forEach(([name, data]) => {
                const card = document.createElement('div');
                card.className = 'sound-card';
                if (selectedSound === name) {
                    card.classList.add('selected');
                }
                
                const fileName = path.basename(data.path);
                
                const volume = (data.volume !== undefined ? data.volume : 1) * 100;
                const speed = data.speed !== undefined ? data.speed : 1;
                const loop = data.loop || false;
                
                // MUDAN√áA: Adiciona info de tempo
                const startTime = data.startTime || 0;
                const endTime = data.endTime || 0;
                const timeText = (endTime > startTime) ? `${startTime.toFixed(1)}s - ${endTime.toFixed(1)}s` : 'Completo';


                card.innerHTML = `
                    <div class="sound-name">${name}</div>
                    <div class="sound-hotkey">‚å®Ô∏è ${data.hotkey}</div>
                    <div class="sound-file">üìÑ ${fileName}</div>
                    <div class="sound-details">
                        <span>üîä ${volume.toFixed(0)}%</span>
                        <span>‚è© ${speed.toFixed(1)}x</span>
                        <span>${loop ? 'üîÑ Repetir' : '‚ñ∂Ô∏è Tocar 1x'}</span>
                    </div>
                    <div class="sound-details" style="border-top: none; padding-top: 5px;">
                         <span>‚è±Ô∏è ${timeText}</span>
                    </div>
                `;
                
                card.onclick = () => selectSoundCard(name);
                card.ondblclick = () => playSound(name);
                
                container.appendChild(card);
            });
        }

        function selectSoundCard(name) {
            selectedSound = name;
            renderSounds();
        }

        function updateSliderLabels() {
            // ... (sem mudan√ßas aqui) ...
            try {
                const vol = document.getElementById('soundVolume').value;
                document.getElementById('volumeValue').textContent = `${Math.round(vol * 100)}%`;
                
                const speed = document.getElementById('soundSpeed').value;
                document.getElementById('speedValue').textContent = `${parseFloat(speed).toFixed(1)}x`;
            } catch (e) {
                console.warn("Erro ao atualizar labels dos sliders:", e);
            }
        }

        function openAddModal() {
            document.getElementById('modalTitle').textContent = 'Adicionar Novo Som';
            document.getElementById('originalSoundName').value = ''; 
            
            document.getElementById('soundName').value = '';
            document.getElementById('soundHotkey').value = '';
            document.getElementById('fileName').textContent = 'Nenhum arquivo selecionado';
            selectedFilePath = null;

            document.getElementById('soundVolume').value = 1;
            document.getElementById('soundSpeed').value = 1;
            document.getElementById('soundLoop').checked = false;
            
            // MUDAN√áA: Reseta os campos de tempo
            document.getElementById('soundStartTime').value = 0;
            document.getElementById('soundEndTime').value = 0;

            updateSliderLabels(); 
            setupHotkeyCapture();
            document.getElementById('addModal').style.display = 'block';
        }

        function openEditModal() {
            if (!selectedSound || !sounds[selectedSound]) {
                alert('Selecione um som para editar!');
                return;
            }

            const data = sounds[selectedSound];

            document.getElementById('modalTitle').textContent = 'Editar Som';
            document.getElementById('originalSoundName').value = selectedSound; 
            
            document.getElementById('soundName').value = selectedSound;
            document.getElementById('soundHotkey').value = data.hotkey;
            document.getElementById('fileName').textContent = path.basename(data.path);
            selectedFilePath = data.path;

            document.getElementById('soundVolume').value = data.volume !== undefined ? data.volume : 1;
            document.getElementById('soundSpeed').value = data.speed !== undefined ? data.speed : 1;
            document.getElementById('soundLoop').checked = data.loop || false;

            // MUDAN√áA: Carrega os campos de tempo
            document.getElementById('soundStartTime').value = data.startTime || 0;
            document.getElementById('soundEndTime').value = data.endTime || 0;

            updateSliderLabels(); 
            setupHotkeyCapture();
            document.getElementById('addModal').style.display = 'block';
        }


        function closeAddModal() {
            // ... (sem mudan√ßas aqui) ...
            document.getElementById('addModal').style.display = 'none';
            isCapturingHotkey = false;
            capturedKeys.clear();
            selectedFilePath = null;
            document.getElementById('originalSoundName').value = '';
        }

        async function selectFile() {
            // ... (sem mudan√ßas aqui) ...
            const filePath = await ipcRenderer.invoke('select-audio-file');
            if (filePath) {
                selectedFilePath = filePath;
                document.getElementById('fileName').textContent = path.basename(filePath);
            }
        }

        async function saveSound() {
            const name = document.getElementById('soundName').value.trim();
            const hotkey = document.getElementById('soundHotkey').value.trim();
            const originalName = document.getElementById('originalSoundName').value;

            const volume = parseFloat(document.getElementById('soundVolume').value);
            const speed = parseFloat(document.getElementById('soundSpeed').value);
            const loop = document.getElementById('soundLoop').checked;

            // MUDAN√áA: Salva os campos de tempo
            const startTime = parseFloat(document.getElementById('soundStartTime').value) || 0;
            const endTime = parseFloat(document.getElementById('soundEndTime').value) || 0;

            if (!name) { /* ... (sem mudan√ßas aqui) ... */ }
            if (!hotkey) { /* ... (sem mudan√ßas aqui) ... */ }
            if (!selectedFilePath) { /* ... (sem mudan√ßas aqui) ... */ }
            if (name !== originalName && sounds[name]) { /* ... (sem mudan√ßas aqui) ... */ }
            if (originalName && originalName !== name) {
                delete sounds[originalName];
            }
            
            // MUDAN√áA: Adiciona os campos de tempo ao objeto salvo
            sounds[name] = {
                path: selectedFilePath,
                hotkey: hotkey,
                volume: volume,
                speed: speed,
                loop: loop,
                startTime: startTime,
                endTime: endTime
            };
            
            await saveConfig();
            selectedSound = name; 
            renderSounds();
            closeAddModal();
            
            alert(`Som "${name}" salvo com sucesso!`);
        }

        async function removeSound() {
            // ... (sem mudan√ßas aqui) ...
            if (!selectedSound) {
                alert('Selecione um som para remover!');
                return;
            }
            if (confirm(`Deseja remover o som "${selectedSound}"?`)) {
                delete sounds[selectedSound];
                await saveConfig();
                selectedSound = null;
                renderSounds();
            }
        }

        function testSelected() {
            // ... (sem mudan√ßas aqui) ...
            if (!selectedSound) {
                alert('Selecione um som para testar!');
                return;
            }
            playSound(selectedSound);
        }

        // 
        // MUDAN√áA PRINCIPAL: L√ìGICA DE 'playSound'
        //
        function playSound(name) {
            if (!sounds[name]) return;
            
            const data = sounds[name];

            // Para o √°udio anterior e limpa o timer
            if (currentAudio) {
                currentAudio.pause();
                currentAudio.currentTime = 0;
                currentAudio.src = ''; 
                currentAudio = null;
            }
            if (stopAudioTimer) {
                clearTimeout(stopAudioTimer);
                stopAudioTimer = null;
            }
            
            try {
                currentAudio = new Audio(data.path);

                const startTime = data.startTime || 0;
                const endTime = data.endTime || 0;

                currentAudio.volume = data.volume !== undefined ? data.volume : 1;
                currentAudio.playbackRate = data.speed !== undefined ? data.speed : 1;
                currentAudio.loop = data.loop || false;

                // Define o ponto de in√≠cio
                currentAudio.currentTime = startTime;

                // Inicia o √°udio
                currentAudio.play().catch(err => {
                    console.error('Erro ao reproduzir √°udio:', err);
                    alert('Erro ao reproduzir o √°udio. Verifique se o arquivo existe.');
                    currentAudio = null;
                });

                // Se tiver um tempo de fim E n√£o for loop, agenda para parar
                if (endTime > startTime && !currentAudio.loop) {
                    const durationInMs = (endTime - startTime) * 1000 / currentAudio.playbackRate;
                    
                    stopAudioTimer = setTimeout(() => {
                        if (currentAudio) {
                            currentAudio.pause();
                            currentAudio.currentTime = startTime; // Reseta
                        }
                    }, durationInMs);
                }

                // Se for loop E tiver tempo de fim, usa 'timeupdate' para
                // voltar ao in√≠cio (cria um loop customizado)
                if (endTime > startTime && currentAudio.loop) {
                    currentAudio.addEventListener('timeupdate', function() {
                        if (this.currentTime >= endTime) {
                            this.currentTime = startTime; // Volta ao in√≠cio
                        }
                    });
                }

            } catch (error) {
                console.error('Erro ao criar Audio:', error);
                alert('Erro ao carregar o √°udio.');
                currentAudio = null;
            }
        }

        ipcRenderer.on('play-sound', (event, name) => {
            playSound(name);
        });

        window.onclick = function(event) {
            // ... (sem mudan√ßas aqui) ...
            const modal = document.getElementById('addModal');
            if (event.target === modal) {
                closeAddModal();
            }
        }

        document.addEventListener('keydown', (e) => {
            // ... (sem mudan√ßas aqui) ...
            if (e.key === 'Enter' && document.getElementById('addModal').style.display === 'block') {
                if (!isCapturingHotkey) {
                    saveSound();
                }
            }
            if (e.key === 'Escape') {
                closeAddModal();
            }
        });

        // Sistema de captura de atalhos (VERS√ÉO CORRIGIDA)
        function setupHotkeyCapture() {
            const hotkeyInput = document.getElementById('soundHotkey');

            hotkeyInput.addEventListener('focus', () => {
                isCapturingHotkey = true;
                capturedKeys.clear();
                hotkeyInput.value = '';
                hotkeyInput.placeholder = 'Pressione as teclas...';
            });

            hotkeyInput.addEventListener('blur', () => {
                isCapturingHotkey = false; // Garante que a captura pare
                if (hotkeyInput.value === '') {
                    hotkeyInput.placeholder = 'Clique aqui e pressione as teclas...';
                }
            });
        }

        //
        // MUDAN√áA: L√≥gica de captura de atalho
        //
        document.addEventListener('keydown', (e) => {
            const hotkeyInput = document.getElementById('soundHotkey');
            
            if (isCapturingHotkey && document.getElementById('addModal').style.display === 'block') {
                e.preventDefault();
                
                // MUDAN√áA 1: Ignora S√ì Ctrl, Shift e Alt sozinhos (removemos 'Meta')
                if (['Control', 'Shift', 'Alt'].includes(e.key)) {
                    return;
                }
                
                const keys = [];
                
                // MUDAN√áA 2: Adiciona modificadores (removemos 'e.metaKey')
                if (e.ctrlKey) {
                    keys.push('CommandOrControl');
                }
                if (e.shiftKey) {
                    keys.push('Shift');
                }
                if (e.altKey) {
                    keys.push('Alt');
                }
                
                let key = e.key;
                
                const specialKeys = {
                    ' ': 'Space', 'ArrowUp': 'Up', 'ArrowDown': 'Down',
                    'ArrowLeft': 'Left', 'ArrowRight': 'Right', 'Escape': 'Esc'
                };
                
                if (specialKeys[key]) {
                    key = specialKeys[key];
                } else if (key.length === 1) {
                    key = key.toUpperCase();
                }
                
                // MUDAN√áA 3: Adiciona a tecla principal (removemos 'SUPER')
                if (!['CONTROL', 'SHIFT', 'ALT'].includes(key.toUpperCase())) {
                     keys.push(key);
                }
               
                const hotkey = keys.join('+');
                hotkeyInput.value = hotkey;
                
                setTimeout(() => {
                    isCapturingHotkey = false;
                    hotkeyInput.blur();
                }, 100);
            }
        });

        function clearHotkey() {
            // ... (sem mudan√ßas aqui) ...
            document.getElementById('soundHotkey').value = '';
            capturedKeys.clear();
        }
    </script>
</body>
</html> -->